<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シミュレーション制御ユーティリティ</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .test-banner {
            background-color: #ff6b6b;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .panel {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
        }
        .panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        .control-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .control-group label {
            margin-right: 10px;
            font-weight: bold;
        }
        .status-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 0 10px;
        }
        .status-offline {
            background-color: #ff6b6b;
            color: white;
        }
        .status-online {
            background-color: #4CAF50;
            color: white;
        }
        .button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .primary {
            background-color: #3498db;
            color: white;
        }
        .primary:hover {
            background-color: #2980b9;
        }
        .secondary {
            background-color: #95a5a6;
            color: white;
        }
        .secondary:hover {
            background-color: #7f8c8d;
        }
        .warning {
            background-color: #e74c3c;
            color: white;
        }
        .warning:hover {
            background-color: #c0392b;
        }
        .device-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fff;
        }
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .device-item:last-child {
            border-bottom: none;
        }
        .device-item:hover {
            background-color: #f5f5f5;
        }
        .device-info {
            flex-grow: 1;
        }
        .device-controls {
            display: flex;
            gap: 5px;
        }
        .device-controls button {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            border: none;
        }
        .delete-device-btn {
            background-color: #ff6b6b;
            color: white;
        }
        .delete-device-btn:hover {
            background-color: #e74c3c;
        }
        .view-device-btn {
            background-color: #3498db;
            color: white;
        }
        .view-device-btn:hover {
            background-color: #2980b9;
        }
        .device-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
            background-color: #95a5a6;
            color: white;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }
        .connected {
            background-color: #4CAF50;
            color: white;
        }
        .disconnected {
            background-color: #ff6b6b;
            color: white;
        }
        .log-panel {
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 0;
            padding: 2px 0;
        }
        .timestamp {
            color: #95a5a6;
            margin-right: 8px;
        }
        .log-info {
            color: #3498db;
        }
        .log-error {
            color: #e74c3c;
        }
        .log-success {
            color: #2ecc71;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-banner">
            テスト用シミュレーション制御ユーティリティ - 本番環境では使用しないでください
        </div>

        <h1>レバーデバイス シミュレーション制御</h1>

        <div class="panel">
            <h2>接続ステータス</h2>
            <div class="control-group">
                <label>API サーバー:</label>
                <span id="serverStatus" class="status-badge status-offline">切断</span>
                <span id="wsAddress">ws://localhost:5001</span>
            </div>
        </div>

        <div class="panel" id="simulationPanel">
            <h2>シミュレーションモード</h2>
            <div class="control-group">
                <label>ステータス:</label>
                <span id="simStatus" class="status-badge status-offline">無効</span>
                <button id="toggleSimulation" class="button primary">有効/無効の切り替え</button>
            </div>

            <div class="control-group">
                <label>デバイス数:</label>
                <input type="number" id="deviceCount" min="1" max="20" value="3">
                <button id="updateDeviceCount" class="button secondary">更新</button>
            </div>

            <h2>デバイス管理</h2>
            <div class="device-list" id="simDeviceList">
                <p class="placeholder">シミュレーションモードが無効です</p>
            </div>

            <div class="control-group">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label for="addDeviceCount">追加数:</label>
                    <input type="number" id="addDeviceCount" min="1" max="5" value="1" style="width: 60px;">
                    <button id="addDevice" class="button secondary">デバイスを追加</button>
                    <button id="removeLastDevice" class="button warning">最新デバイスを削除</button>
                    <button id="clearAllDevices" class="button warning">すべてクリア</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>ログ</h2>
            <div class="log-panel" id="logPanel"></div>
        </div>

        <div class="footer">
            <p>【テスト環境】 &copy; 2023 Pedantic Co., Ltd. All rights reserved.</p>
        </div>
    </div>

    <script>
        // アプリケーション状態
        const state = {
            socket: null,
            connected: false,
            simEnabled: false,
            deviceCount: 3,
            devices: []
        };

        // DOM要素
        const elements = {
            serverStatus: document.getElementById('serverStatus'),
            wsAddress: document.getElementById('wsAddress'),
            simStatus: document.getElementById('simStatus'),
            toggleSimulation: document.getElementById('toggleSimulation'),
            deviceCount: document.getElementById('deviceCount'),
            updateDeviceCount: document.getElementById('updateDeviceCount'),
            simDeviceList: document.getElementById('simDeviceList'),
            addDevice: document.getElementById('addDevice'),
            addDeviceCount: document.getElementById('addDeviceCount'),
            removeLastDevice: document.getElementById('removeLastDevice'),
            clearAllDevices: document.getElementById('clearAllDevices'),
            logPanel: document.getElementById('logPanel')
        };

        // ログ追加関数
        function addLog(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];

            const logEntry = document.createElement('p');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;

            elements.logPanel.appendChild(logEntry);
            elements.logPanel.scrollTop = elements.logPanel.scrollHeight;
        }

        // APIサーバー接続テスト
        async function checkApiServer() {
            try {
                // API接続確認のリクエスト（タイムアウト付き）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒タイムアウト

                addLog('APIサーバーへの接続を確認中...', 'info');
                const response = await fetch('/api/status', {
                    signal: controller.signal,
                    method: 'GET'
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        throw new Error('接続タイムアウト - APIサーバーが応答しません');
                    }
                    throw error;
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`APIサーバーエラー: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                addLog('APIサーバーに正常に接続しました', 'success');
                console.log('API接続確認完了:', data);
                return true;
            } catch (error) {
                console.error('API接続エラー:', error);
                addLog(`APIサーバー接続エラー: ${error.message}`, 'error');
                addLog(`APIサーバー(ポート5001)が起動しているか確認してください`, 'error');
                elements.serverStatus.textContent = 'エラー';
                elements.serverStatus.className = 'status-badge status-offline';
                return false;
            }
        }

        // WebSocket初期化
        function initWebSocket() {
            if (state.socket) {
                state.socket.disconnect();
            }

            try {
                const apiPort = 5001; // APIサーバーポート
                state.socket = io(`http://${window.location.hostname}:${apiPort}`, {
                    reconnectionAttempts: 3,
                    timeout: 5000,
                    reconnectionDelay: 1000
                });

                state.socket.on('connect', () => {
                    state.connected = true;
                    elements.serverStatus.textContent = '接続中';
                    elements.serverStatus.className = 'status-badge status-online';
                    elements.wsAddress.textContent = `ws://${window.location.hostname}:${apiPort}`;
                    addLog('APIサーバーに接続しました', 'success');

                    // 接続時にAPI接続確認
                    checkApiServer().then(isConnected => {
                        if (isConnected) {
                            // APIサーバーに接続できた場合のみシミュレーション状態を取得
                            getSimulationStatus();
                        }
                    });
                });

                state.socket.on('connect_error', (error) => {
                    console.error('WebSocket接続エラー:', error);
                    state.connected = false;
                    elements.serverStatus.textContent = 'エラー';
                    elements.serverStatus.className = 'status-badge status-offline';
                    addLog(`WebSocket接続エラー: APIサーバー(ポート${apiPort})が応答しません`, 'error');
                    addLog(`APIサーバーが起動していることを確認してください`, 'error');
                });

                state.socket.on('disconnect', () => {
                    state.connected = false;
                    elements.serverStatus.textContent = '切断';
                    elements.serverStatus.className = 'status-badge status-offline';
                    addLog('APIサーバーから切断されました', 'error');
                });

                state.socket.on('error', (error) => {
                    console.error('WebSocketエラー:', error);
                    addLog(`WebSocketエラー: ${error.message || JSON.stringify(error)}`, 'error');
                });
            } catch (error) {
                console.error('WebSocket初期化エラー:', error);
                addLog(`WebSocket初期化エラー: ${error.message}`, 'error');
            }
        }

        // シミュレーション状態取得
        async function getSimulationStatus() {
            try {
                addLog('シミュレーション状態を取得中...');

                // APIサーバーの接続状態を最初に確認
                const serverCheck = await checkApiServer().catch(() => false);
                if (!serverCheck) {
                    addLog('APIサーバーに接続できないため、シミュレーション状態の取得を中止します', 'error');
                    return;
                }

                // タイムアウト付きリクエスト
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒タイムアウト

                console.log('API呼び出し開始: /api/simulation/status');
                const response = await fetch('/api/simulation/status', {
                    signal: controller.signal
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        throw new Error('接続タイムアウト - APIサーバーが応答しません');
                    }
                    throw error;
                });

                clearTimeout(timeoutId);

                console.log('API応答:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`APIサーバーエラー: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('シミュレーション状態データ:', data);

                if (data.status === 'success') {
                    state.simEnabled = data.data.simulation_mode;
                    state.deviceCount = data.data.device_count;

                    // UIコントロールを更新する前に要素の存在確認を徹底する
                    // DOM要素が完全に初期化されるまで待機する
                    await new Promise(resolve => {
                        // DOM要素が既に初期化されているかチェック
                        if (document.readyState === 'complete' &&
                            document.getElementById('simStatus') &&
                            document.getElementById('deviceCount') &&
                            document.getElementById('updateDeviceCount') &&
                            document.getElementById('simDeviceList')) {
                            resolve();
                            return;
                        }

                        // 完全に読み込まれるまで待機
                        const checkReady = () => {
                            if (document.readyState === 'complete' &&
                                document.getElementById('simStatus') &&
                                document.getElementById('deviceCount') &&
                                document.getElementById('updateDeviceCount') &&
                                document.getElementById('simDeviceList')) {
                                resolve();
                            } else {
                                setTimeout(checkReady, 50); // 50ms後に再チェック
                            }
                        };

                        checkReady();
                    });

                    // elements辞書を再初期化して確実に最新の要素を参照
                    Object.keys(elements).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) {
                            elements[key] = el;
                        } else {
                            console.warn(`要素 '${key}' が見つかりません`);
                        }
                    });

                    // 要素の存在を再確認
                    const isUIReady = elements.updateDeviceCount && elements.deviceCount &&
                                     elements.addDevice && elements.simStatus;

                    console.log('UI初期化状態:', {
                        documentReady: document.readyState === 'complete',
                        elementsReady: isUIReady,
                        updateDeviceCount: !!elements.updateDeviceCount,
                        deviceCount: !!elements.deviceCount,
                        addDevice: !!elements.addDevice,
                        simStatus: !!elements.simStatus
                    });

                    // 安全にUI更新を試みる
                    try {
                        if (isUIReady) {
                            updateSimulationUI();
                        } else {
                            addLog('UI要素が完全に初期化されていないため、手動でページを更新してください', 'error');
                        }
                    } catch (uiError) {
                        console.error('UI更新エラー:', uiError);
                        addLog(`UI更新エラー: ${uiError.message}`, 'error');
                    }

                    // シミュレーションモードが有効な場合はデバイス取得
                    if (state.simEnabled) {
                        try {
                            await getSimulationDevices();
                        } catch (devErr) {
                            console.error('デバイス取得エラー:', devErr);
                        }
                    }

                    addLog(`シミュレーション状態: ${state.simEnabled ? '有効' : '無効'}、デバイス数: ${state.deviceCount}`, 'info');
                } else {
                    addLog(`API応答エラー: ${data.message || '不明なエラー'}`, 'error');
                }
            } catch (error) {
                // エラーの詳細をログに記録
                console.error('シミュレーション状態取得エラー:', error);
                addLog(`シミュレーション状態取得エラー: ${error.message}`, 'error');

                // API接続の問題がある場合は、ユーザーに明確な指示を表示
                if (error.message.includes('タイムアウト') || error.message.includes('ネットワーク')) {
                    addLog('APIサーバーが応答していません。APIサーバー(ポート5001)が起動していることを確認してください', 'error');
                } else {
                    addLog('詳細はブラウザのコンソールを確認してください', 'error');
                }
            }
        }

        // シミュレーションデバイス一覧取得
        async function getSimulationDevices() {
            try {
                addLog('シミュレーションデバイス一覧を取得中...');
                const response = await fetch('/api/simulation/devices');
                const data = await response.json();

                if (data.status === 'success') {
                    state.devices = data.data.devices;
                    updateDeviceListUI();

                    addLog(`${state.devices.length}個のシミュレーションデバイスを取得しました`, 'success');
                }
            } catch (error) {
                addLog(`シミュレーションデバイス取得エラー: ${error.message}`, 'error');
            }
        }

        // シミュレーションモード切り替え
        async function toggleSimulationMode() {
            try {
                if (elements.toggleSimulation) {
                    elements.toggleSimulation.disabled = true;
                }
                addLog('シミュレーションモードを切り替え中...');

                // APIサーバーの接続状態を最初に確認
                const serverCheck = await checkApiServer().catch(() => false);
                if (!serverCheck) {
                    addLog('APIサーバーに接続できないため、操作を中止します', 'error');
                    addLog('APIサーバー(ポート5001)が起動していることを確認してください', 'error');
                    return;
                }

                // タイムアウト付きリクエスト
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒タイムアウト

                console.log('API呼び出し開始: /api/simulation/toggle (POST)');
                const response = await fetch('/api/simulation/toggle', {
                    method: 'POST',
                    signal: controller.signal
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        throw new Error('接続タイムアウト - APIサーバーが応答しません');
                    }
                    throw error;
                });

                clearTimeout(timeoutId);

                console.log('API応答:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`APIサーバーエラー: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('シミュレーションモード切り替えレスポンス:', data);

                if (data.status === 'success') {
                    state.simEnabled = data.data.simulation_mode;

                    // UI更新の詳細デバッグ
                    console.log('シミュレーションモード:', state.simEnabled);
                    console.log('UI要素:', {
                        toggleSimulation: !!elements.toggleSimulation,
                        updateDeviceCount: !!elements.updateDeviceCount,
                        deviceCount: !!elements.deviceCount,
                        addDevice: !!elements.addDevice,
                        simStatus: !!elements.simStatus
                    });

                    // 安全にUI更新
                    try {
                        if (document.readyState === 'complete') {
                            const isUIReady = elements.updateDeviceCount && elements.deviceCount &&
                                            elements.addDevice && elements.simStatus;

                            if (isUIReady) {
                                updateSimulationUI();
                                addLog('UIを更新しました', 'info');
                            } else {
                                console.warn('UI要素が初期化されていません');
                                addLog('UI要素の初期化が不完全なため、一部の表示が更新されません', 'error');
                            }
                        }
                    } catch (uiError) {
                        console.error('UI更新エラー:', uiError);
                        addLog('UI更新中にエラーが発生しました', 'error');
                    }

                    // シミュレーションモードが有効な場合はデバイス取得
                    if (state.simEnabled) {
                        try {
                            await getSimulationDevices();
                        } catch (devicesError) {
                            console.error('デバイス取得エラー:', devicesError);
                            addLog('シミュレーションデバイスの取得中にエラーが発生しました', 'error');
                        }
                    }

                    addLog(`シミュレーションモードを${state.simEnabled ? '有効' : '無効'}にしました`, 'success');
                } else {
                    addLog(`エラー: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('シミュレーションモード切り替えエラー:', error);
                addLog(`シミュレーションモード切り替えエラー: ${error.message}`, 'error');

                // API接続の問題がある場合は、ユーザーに明確な指示を表示
                if (error.message.includes('タイムアウト') || error.message.includes('ネットワーク')) {
                    addLog('APIサーバーが応答していません。APIサーバー(ポート5001)が起動していることを確認してください', 'error');
                }
            } finally {
                if (elements.toggleSimulation) {
                    elements.toggleSimulation.disabled = false;
                }
            }
        }

        // デバイス数更新
        async function updateSimulationDeviceCount() {
            const count = parseInt(elements.deviceCount.value, 10);

            if (isNaN(count) || count < 1 || count > 20) {
                addLog('デバイス数は1～20の範囲で指定してください', 'error');
                return;
            }

            try {
                elements.updateDeviceCount.disabled = true;
                addLog(`デバイス数を${count}に更新中...`);

                const response = await fetch('/api/simulation/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ device_count: count })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    state.deviceCount = data.data.device_count;
                    elements.deviceCount.value = state.deviceCount;

                    // 現在のシミュレーション状態に応じてUI更新
                    if (state.simEnabled) {
                        // デバイスリストを更新して自動的に新しい状態を反映
                        await getSimulationDevices();

                        // 上限が増えた場合に既存のデバイスを確認
                        const currentDeviceCount = state.devices ? state.devices.length : 0;

                        // もし上限を増やしたのに実際のデバイス数が少なければ、不足分を自動追加
                        if (currentDeviceCount < count) {
                            const neededDevices = count - currentDeviceCount;
                            addLog(`デバイス数上限が増加しました。不足分のデバイス(${neededDevices}個)を追加中...`, 'info');

                            // 不足分のデバイスを自動追加
                            for (let i = 0; i < neededDevices; i++) {
                                try {
                                    const addResponse = await fetch('/api/simulation/devices/add', {
                                        method: 'POST'
                                    });
                                    const addData = await addResponse.json();

                                    if (addData.status === 'success') {
                                        state.devices = addData.data.simulation_devices;
                                    }
                                } catch (addError) {
                                    console.error('デバイス自動追加エラー:', addError);
                                }
                            }

                            // 最終的なUI更新
                            updateDeviceListUI();
                            addLog(`${neededDevices}個のデバイスを自動追加しました`, 'success');
                        }
                    }

                    addLog(`シミュレーションデバイス数を${count}に更新しました`, 'success');
                } else {
                    addLog(`エラー: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`デバイス数更新エラー: ${error.message}`, 'error');
            } finally {
                elements.updateDeviceCount.disabled = false;
            }
        }

        // デバイス追加 (複数対応、自動リミット拡張機能あり)
        async function addSimulationDevice() {
            // APIサーバーの接続状態を最初に確認
            const serverCheck = await checkApiServer().catch(() => false);
            if (!serverCheck) {
                addLog('APIサーバーに接続できないため、操作を中止します', 'error');
                return;
            }

            if (!state.simEnabled) {
                addLog('シミュレーションモードが無効です', 'error');
                // シミュレーションモードが無効の場合は自動的に有効化を試みる
                addLog('シミュレーションモードを自動的に有効化しています...', 'info');
                try {
                    await toggleSimulationMode();
                    if (!state.simEnabled) {
                        addLog('シミュレーションモードの有効化に失敗しました', 'error');
                        return;
                    }
                } catch (err) {
                    addLog('シミュレーションモードの有効化中にエラーが発生しました', 'error');
                    return;
                }
            }

            // 追加デバイス数を取得 (要素が存在しない場合はデフォルト値1を使用)
            let count = 1;
            if (elements.addDeviceCount && elements.addDeviceCount.value) {
                count = parseInt(elements.addDeviceCount.value, 10) || 1;
            }
            if (count < 1 || count > 5) {
                addLog('追加デバイス数は1～5の範囲で指定してください', 'error');
                return;
            }

            try {
                // 追加ボタンを無効化 (存在チェック付き)
                if (elements.addDevice) elements.addDevice.disabled = true;
                addLog(`シミュレーションデバイスを${count}個追加中...`);

                let addedDevices = [];
                let needToIncreaseLimit = false;
                let limitErrorCount = 0;

                // 指定回数だけデバイスを追加
                for (let i = 0; i < count; i++) {
                    try {
                        const response = await fetch('/api/simulation/devices/add', {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            state.devices = data.data.simulation_devices;
                            addedDevices.push(data.data.added_device_id);
                        } else {
                            // デバイス上限エラーの場合、上限を増やして再試行する
                            if (data.message && data.message.includes('device_count limit')) {
                                needToIncreaseLimit = true;
                                limitErrorCount = count - i;
                                addLog(`デバイス上限に達しました。上限を自動的に増やします...`, 'info');
                                break;
                            } else {
                                addLog(`エラー (${i+1}個目): ${data.message}`, 'error');
                                break;
                            }
                        }
                    } catch (addErr) {
                        addLog(`デバイス追加エラー (${i+1}個目): ${addErr.message}`, 'error');
                        break;
                    }
                }

                // デバイス上限に達した場合は、自動的に上限を増やして再試行
                if (needToIncreaseLimit) {
                    const currentLimit = state.deviceCount || 3; // デフォルト値を設定
                    const newLimit = currentLimit + limitErrorCount;
                    addLog(`デバイス上限を${currentLimit}から${newLimit}に自動的に増やします`, 'info');

                    try {
                        // 上限設定を更新
                        const configResponse = await fetch('/api/simulation/config', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ device_count: newLimit })
                        });

                        const configData = await configResponse.json();

                        if (configData.status === 'success') {
                            state.deviceCount = configData.data.device_count;
                            if (elements.deviceCount) elements.deviceCount.value = state.deviceCount;
                            addLog(`デバイス上限を${newLimit}に増やしました。残りのデバイスを追加中...`, 'success');

                            // 残りのデバイスを追加
                            for (let i = 0; i < limitErrorCount; i++) {
                                try {
                                    const addResponse = await fetch('/api/simulation/devices/add', {
                                        method: 'POST'
                                    });
                                    const addData = await addResponse.json();

                                    if (addData.status === 'success') {
                                        state.devices = addData.data.simulation_devices;
                                        addedDevices.push(addData.data.added_device_id);
                                    } else {
                                        addLog(`追加エラー: ${addData.message}`, 'error');
                                        break;
                                    }
                                } catch (addError) {
                                    addLog(`デバイス追加エラー: ${addError.message}`, 'error');
                                    break;
                                }
                            }
                        } else {
                            addLog(`デバイス上限更新エラー: ${configData.message}`, 'error');
                        }
                    } catch (configErr) {
                        addLog(`デバイス上限設定エラー: ${configErr.message}`, 'error');
                    }
                }

                // デバイスリストUIを更新
                try {
                    updateDeviceListUI();
                } catch (uiErr) {
                    console.error('デバイスリスト更新エラー:', uiErr);
                    addLog(`デバイスリスト更新エラー: ${uiErr.message}`, 'error');
                }

                // 追加結果をログに表示
                if (addedDevices.length > 0) {
                    if (addedDevices.length === 1) {
                        addLog(`シミュレーションデバイスを追加しました: ${addedDevices[0]}`, 'success');
                    } else {
                        addLog(`シミュレーションデバイスを${addedDevices.length}個追加しました: ${addedDevices.join(', ')}`, 'success');
                    }
                } else {
                    addLog('デバイスを追加できませんでした', 'error');
                }
            } catch (error) {
                console.error('デバイス追加エラー:', error);
                addLog(`デバイス追加エラー: ${error.message}`, 'error');
            } finally {
                // ボタン状態を元に戻す (存在チェック付き)
                if (elements.addDevice) elements.addDevice.disabled = false;
            }
        }

        // 最新のデバイスを削除
        async function removeLastDevice() {
            if (!state.simEnabled) {
                addLog('シミュレーションモードが無効です', 'error');
                return;
            }

            if (state.devices.length === 0) {
                addLog('削除するデバイスがありません', 'error');
                return;
            }

            try {
                elements.removeLastDevice.disabled = true;
                addLog('最新のシミュレーションデバイスを削除中...');

                const response = await fetch('/api/simulation/devices/remove', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    state.devices = data.data.remaining_devices;
                    updateDeviceListUI();

                    addLog(`シミュレーションデバイスを削除しました: ${data.data.removed_device_id}`, 'success');
                } else {
                    addLog(`エラー: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`デバイス削除エラー: ${error.message}`, 'error');
            } finally {
                elements.removeLastDevice.disabled = false;
            }
        }

        // 特定デバイス削除
        async function removeSpecificSimulationDevice(deviceId) {
            if (!state.simEnabled) {
                addLog('シミュレーションモードが無効です', 'error');
                return;
            }

            if (!deviceId) {
                return;
            }

            if (!deviceId.startsWith('sim_')) {
                addLog('有効なシミュレーションデバイスIDを指定してください（例: sim_2）', 'error');
                return;
            }

            try {
                addLog(`デバイス ${deviceId} を削除中...`);

                // デバイス項目を一時的に削除ボタンを無効化
                const deviceElement = document.querySelector(`.device-item[data-device-id="${deviceId}"]`);
                if (deviceElement) {
                    const deleteBtn = deviceElement.querySelector('.delete-device-btn');
                    if (deleteBtn) deleteBtn.disabled = true;
                }

                const response = await fetch('/api/simulation/devices/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    state.devices = data.data.remaining_devices;
                    updateDeviceListUI();

                    addLog(`シミュレーションデバイスを削除しました: ${data.data.removed_device_id}`, 'success');
                } else {
                    addLog(`エラー: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`デバイス削除エラー: ${error.message}`, 'error');
            }
        }

        // すべてのシミュレーションデバイスをクリア
        async function clearAllDevices() {
            if (!state.simEnabled) {
                addLog('シミュレーションモードが無効です', 'error');
                return;
            }

            if (state.devices.length === 0) {
                addLog('デバイスがありません', 'info');
                return;
            }

            if (!confirm(`${state.devices.length}個のシミュレーションデバイスをすべて削除します。よろしいですか？`)) {
                return;
            }

            try {
                elements.clearAllDevices.disabled = true;
                addLog('すべてのシミュレーションデバイスを削除中...');

                // 現在のデバイスをコピー
                const deviceIds = state.devices.map(device => device.id);
                let successCount = 0;
                let errorCount = 0;

                // 各デバイスを順番に削除
                for (const deviceId of deviceIds) {
                    try {
                        const response = await fetch('/api/simulation/devices/remove', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ device_id: deviceId })
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            successCount++;
                            state.devices = data.data.remaining_devices;
                        } else {
                            errorCount++;
                            addLog(`デバイス ${deviceId} の削除エラー: ${data.message}`, 'error');
                        }
                    } catch (error) {
                        errorCount++;
                        addLog(`デバイス ${deviceId} の削除でエラーが発生: ${error.message}`, 'error');
                    }
                }

                updateDeviceListUI();

                if (successCount > 0) {
                    addLog(`${successCount}個のシミュレーションデバイスを削除しました`, 'success');
                }

                if (errorCount > 0) {
                    addLog(`${errorCount}個のデバイスは削除できませんでした`, 'error');
                }

            } catch (error) {
                addLog(`デバイス一括削除エラー: ${error.message}`, 'error');
            } finally {
                elements.clearAllDevices.disabled = false;
            }
        }

        // シミュレーションUI更新
        function updateSimulationUI() {
            console.log('updateSimulationUI called - state:', { simEnabled: state.simEnabled, deviceCount: state.deviceCount });

            try {
                // 最初に必要なDOM要素を直接取得して確実に最新の参照を使用
                const uiElements = {
                    simStatus: document.getElementById('simStatus'),
                    deviceCount: document.getElementById('deviceCount'),
                    updateDeviceCount: document.getElementById('updateDeviceCount'),
                    addDevice: document.getElementById('addDevice'),
                    addDeviceCount: document.getElementById('addDeviceCount'),
                    removeLastDevice: document.getElementById('removeLastDevice'),
                    clearAllDevices: document.getElementById('clearAllDevices'),
                    simDeviceList: document.getElementById('simDeviceList')
                };

                // 必須要素の存在確認
                const requiredElements = ['simStatus', 'deviceCount', 'updateDeviceCount',
                                         'addDevice', 'removeLastDevice', 'clearAllDevices',
                                         'simDeviceList'];

                // 不足している要素を確認
                const missingElements = requiredElements.filter(name => !uiElements[name]);
                if (missingElements.length > 0) {
                    console.error('UI更新に必要な要素が見つかりません:', missingElements);
                    addLog(`UI更新エラー: 一部の要素が見つかりません。ページの再読み込みをお試しください。`, 'error');
                    // 不足している要素名を詳細ログに出力
                    console.debug('不足している要素:', missingElements.join(', '));
                    return false;
                }

                // 安全対策: elements辞書も更新して確実に最新参照を使用
                Object.keys(uiElements).forEach(key => {
                    if (uiElements[key]) {
                        elements[key] = uiElements[key];
                    }
                });

                if (state.simEnabled) {
                    // シミュレーションモード有効時のUI更新
                    try {
                        // ステータス表示更新
                        uiElements.simStatus.textContent = '有効';
                        uiElements.simStatus.className = 'status-badge status-online';

                        // 入力要素の有効化
                        uiElements.deviceCount.disabled = false;
                        uiElements.updateDeviceCount.disabled = false;
                        uiElements.addDevice.disabled = false;
                        if (uiElements.addDeviceCount) uiElements.addDeviceCount.disabled = false;
                        uiElements.removeLastDevice.disabled = false;
                        uiElements.clearAllDevices.disabled = false;

                        // デバイス数の表示を更新
                        if (state.deviceCount !== undefined) {
                            uiElements.deviceCount.value = state.deviceCount;
                        }

                        addLog('シミュレーションモード：有効', 'success');
                    } catch (enableErr) {
                        console.error('シミュレーションモード有効化中のUI更新エラー:', enableErr);
                        addLog(`UI更新エラー: ${enableErr.message}`, 'error');
                    }
                } else {
                    // シミュレーションモード無効時のUI更新
                    try {
                        // ステータス表示更新
                        uiElements.simStatus.textContent = '無効';
                        uiElements.simStatus.className = 'status-badge status-offline';

                        // 入力要素の無効化
                        uiElements.deviceCount.disabled = true;
                        uiElements.updateDeviceCount.disabled = true;
                        uiElements.addDevice.disabled = true;
                        if (uiElements.addDeviceCount) uiElements.addDeviceCount.disabled = true;
                        uiElements.removeLastDevice.disabled = true;
                        uiElements.clearAllDevices.disabled = true;

                        // デバイスリストをクリア
                        uiElements.simDeviceList.innerHTML = '<p class="placeholder">シミュレーションモードが無効です</p>';

                        addLog('シミュレーションモード：無効', 'info');
                    } catch (disableErr) {
                        console.error('シミュレーションモード無効化中のUI更新エラー:', disableErr);
                        addLog(`UI更新エラー: ${disableErr.message}`, 'error');
                    }
                }

                console.log('シミュレーションUI更新完了');
                return true;
            } catch (error) {
                console.error('シミュレーションUI更新エラー:', error);
                addLog(`シミュレーションUI更新中に予期せぬエラーが発生しました: ${error.message}`, 'error');
                return false;
            }
        }

        // デバイスリストUI更新
        function updateDeviceListUI() {
            if (!state.simEnabled) {
                elements.simDeviceList.innerHTML = '<p class="placeholder">シミュレーションモードが無効です</p>';
                return;
            }

            if (state.devices.length === 0) {
                elements.simDeviceList.innerHTML = '<p class="placeholder">シミュレーションデバイスがありません</p>';
                return;
            }

            elements.simDeviceList.innerHTML = '';

            state.devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.dataset.deviceId = device.id;

                deviceItem.innerHTML = `
                    <div class="device-info">
                        <strong>${device.name}</strong>
                        <span class="device-badge">${device.id}</span>
                        <div style="font-size: 0.9em; color: #777; margin-top: 3px;">IP: ${device.ip}</div>
                    </div>
                    <div class="device-controls">
                        <button class="view-device-btn" data-device-id="${device.id}" title="デバイス情報を表示">情報</button>
                        <button class="delete-device-btn" data-device-id="${device.id}" title="このデバイスを削除">削除</button>
                    </div>
                `;

                elements.simDeviceList.appendChild(deviceItem);

                // 削除ボタンにイベントリスナーを追加
                const deleteBtn = deviceItem.querySelector('.delete-device-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (event) => {
                        const deviceId = event.target.dataset.deviceId;
                        removeSpecificSimulationDevice(deviceId);
                    });
                }

                // 情報表示ボタンにイベントリスナーを追加
                const viewBtn = deviceItem.querySelector('.view-device-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', (event) => {
                        const deviceId = event.target.dataset.deviceId;
                        viewDeviceInfo(deviceId);
                    });
                }
            });
        }

        // デバイス情報を表示する関数
        async function viewDeviceInfo(deviceId) {
            try {
                addLog(`デバイス ${deviceId} の情報を取得中...`);

                // APIサーバーの接続状態を最初に確認
                const serverCheck = await checkApiServer().catch(() => false);
                if (!serverCheck) {
                    addLog('APIサーバーに接続できないため、デバイス情報の取得を中止します', 'error');

                    // APIサーバー起動方法のガイド表示
                    const serverGuide = `
                        デバイス情報を取得できません: APIサーバーが応答していません

                        APIサーバーを起動するには:
                        1. ターミナルでAPIサーバーのディレクトリに移動
                        2. 'python app.py' コマンドを実行してAPIサーバーを起動
                        3. このページを更新して再試行

                        または、統合スクリプトを使用:
                        - macOSの場合: app/macOS/run_leverapp.sh
                        - Windowsの場合: app\\windows\\run_leverapp.bat
                    `;

                    alert(serverGuide.replace(/\n/g, '\n'));
                    return;
                }

                // シミュレーションデバイスの場合、サーバー側のシミュレーションモード状態を直接確認
                if (deviceId.startsWith('sim_')) {
                    addLog(`シミュレーションデバイス ${deviceId} の状態を確認しています...`, 'info');

                    // サーバー側のシミュレーションモード状態を確認
                    try {
                        const simStatusResponse = await fetch('/api/simulation/status');
                        const simStatusData = await simStatusResponse.json();

                        console.log('サーバー側シミュレーション状態:', simStatusData);

                        // サーバー側のシミュレーションモードが無効の場合
                        if (simStatusData.status === 'success' && simStatusData.data && !simStatusData.data.simulation_mode) {
                            addLog(`サーバー側のシミュレーションモードが無効です。有効化を試みます`, 'warning');

                            // 強制的に有効化
                            const toggleResponse = await fetch('/api/simulation/toggle', {
                                method: 'POST'
                            });
                            const toggleData = await toggleResponse.json();

                            if (toggleData.status === 'success' && toggleData.data && toggleData.data.simulation_mode) {
                                addLog('サーバー側のシミュレーションモードを有効化しました', 'success');
                                state.simEnabled = true;

                                // UIを更新
                                updateSimulationUI();
                            } else {
                                addLog('サーバー側のシミュレーションモード有効化に失敗しました', 'error');

                                const simGuide = `
                                    シミュレーションデバイス ${deviceId} の情報を取得できません

                                    サーバー側のシミュレーションモードを有効化できませんでした。

                                    手動で有効化するには:
                                    1. 「有効/無効の切り替え」ボタンをクリックしてください
                                    2. APIサーバーが正常に動作していることを確認してください
                                    3. APIサーバーを再起動してみてください
                                `;

                                alert(simGuide.replace(/\n/g, '\n'));
                                return;
                            }
                        } else if (simStatusData.status === 'success') {
                            // サーバー側のシミュレーションモード状態をUI側の状態と同期
                            if (simStatusData.data && simStatusData.data.simulation_mode !== state.simEnabled) {
                                state.simEnabled = simStatusData.data.simulation_mode;
                                addLog(`シミュレーションモード状態を同期しました: ${state.simEnabled ? '有効' : '無効'}`, 'info');

                                // UIを更新
                                updateSimulationUI();
                            }

                            // デバイス数も同期
                            if (simStatusData.data && simStatusData.data.device_count) {
                                state.deviceCount = simStatusData.data.device_count;
                                if (elements.deviceCount) {
                                    elements.deviceCount.value = state.deviceCount;
                                }
                            }
                        }
                    } catch (simCheckError) {
                        console.error('シミュレーションモード確認エラー:', simCheckError);
                        addLog(`シミュレーションモード確認エラー: ${simCheckError.message}`, 'error');
                    }

                    // シミュレーションデバイスリストを更新
                    try {
                        await getSimulationDevices();
                    } catch (devListErr) {
                        console.error('デバイスリスト更新エラー:', devListErr);
                    }
                }

                // APIからデバイスの値を取得（タイムアウト付き）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒タイムアウト

                // シミュレーションデバイスの場合、明示的にシミュレーションモードパラメータを追加
                let url = `/api/devices/${deviceId}/value`;
                if (deviceId.startsWith('sim_')) {
                    // シミュレーションデバイス用のクエリパラメータを追加
                    url += `?sim_mode=true&force_check=true`;
                    addLog(`シミュレーションデバイス専用パラメータを追加: ${url}`, 'info');
                }

                addLog(`API呼び出し: ${url}`);
                console.log(`デバイス情報取得リクエスト: ${url}`);

                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'X-Simulation-Mode': state.simEnabled ? 'true' : 'false',
                        'X-Device-Type': deviceId.startsWith('sim_') ? 'simulation' : 'real'
                    }
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        throw new Error('接続タイムアウト - APIサーバーが応答しません');
                    }
                    throw error;
                });

                clearTimeout(timeoutId);

                const data = await response.json();
                // より詳細なデバッグ情報を出力
                console.log(`デバイス ${deviceId} 情報取得結果:`, data);
                console.log(`シミュレーションモード状態:`, state.simEnabled);
                console.log(`現在のデバイスリスト:`, state.devices);

                // レスポンスの詳細をログに出力
                addLog(`デバイス ${deviceId} レスポンス: ${data.status}`, data.status === 'success' ? 'success' : 'info');
                if (data.message) {
                    addLog(`メッセージ: ${data.message}`, 'info');
                }

                if (data.status === 'success' && data.data) {
                    // 成功時のデバイス情報表示
                    console.log(`デバイス値データ:`, data.data);
                    const info = `
                        デバイス情報: ${deviceId}
                        ----------------------------------------
                        値: ${data.data.value !== undefined ? data.data.value : 'N/A'}
                        生値: ${data.data.raw !== undefined ? data.data.raw : 'N/A'}
                        タイムスタンプ: ${data.data.timestamp ? new Date(data.data.timestamp * 1000).toLocaleString() : 'N/A'}
                        ステータス: オンライン
                        ----------------------------------------
                        ${deviceId.startsWith('sim_') ? '(シミュレーションデバイス)' : '(実デバイス)'}
                    `;

                    alert(info.replace(/\n/g, '\n'));
                    addLog(`デバイス ${deviceId} の情報を表示しました`, 'success');
                } else if (data.status === 'error' || !data.data) {
                    // エラー種類に応じた詳細情報とガイダンス
                    let errorReason = '';
                    let actionGuidance = '';
                    let retryAction = null;

                    // エラーの理由を特定
                    if (data.message && data.message.includes('offline')) {
                        addLog(`デバイス ${deviceId} はオフラインです`, 'error');
                        errorReason = 'デバイスがオフラインまたは未接続状態です';

                        // シミュレーションデバイスの場合、特別な処理を行う
                        if (deviceId.startsWith('sim_')) {
                            addLog('シミュレーションデバイスをオンライン化する処理を開始します', 'info');

                            // 即時修復処理を試みる
                            try {
                                // シミュレーションモードを一度オフにして再度オンに
                                addLog('シミュレーションモードを再初期化しています...', 'info');

                                // まずシミュレーションモードをオフに
                                await fetch('/api/simulation/toggle', { method: 'POST' });
                                // 少し待機
                                await new Promise(resolve => setTimeout(resolve, 500));
                                // 再度オンに
                                const reToggleResponse = await fetch('/api/simulation/toggle', { method: 'POST' });
                                const reToggleData = await reToggleResponse.json();

                                if (reToggleData.status === 'success' && reToggleData.data.simulation_mode) {
                                    addLog('シミュレーションモードを再初期化しました', 'success');

                                    // 少し待機してからデバイスを再取得
                                    await new Promise(resolve => setTimeout(resolve, 1000));

                                    // デバイスリストを更新
                                    const devicesResponse = await fetch('/api/simulation/devices');
                                    const devicesData = await devicesResponse.json();

                                    if (devicesData.status === 'success') {
                                        state.devices = devicesData.data.devices;
                                        updateDeviceListUI();

                                        // 既存のデバイスに現在のデバイスがあるか確認
                                        const targetDevice = state.devices.find(dev => dev.id === deviceId);

                                        if (!targetDevice) {
                                            // デバイスが見つからない場合、新しいデバイスを追加
                                            addLog(`デバイス ${deviceId} が見つかりません。新しいデバイスを追加します`, 'info');
                                            await addSimulationDevice();
                                        } else {
                                            // デバイスが見つかった場合、再度情報を取得
                                            addLog(`デバイス ${deviceId} が見つかりました。再度情報を取得します`, 'info');

                                            // 再度デバイス情報を取得
                                            retryAction = async () => {
                                                addLog(`デバイス ${deviceId} の情報を再取得しています...`, 'info');
                                                await viewDeviceInfo(deviceId);
                                            };
                                        }
                                    }
                                } else {
                                    addLog('シミュレーションモードの再初期化に失敗しました', 'error');
                                }
                            } catch (recoveryError) {
                                console.error('自動リカバリーエラー:', recoveryError);
                                addLog(`シミュレーションデバイス復旧エラー: ${recoveryError.message}`, 'error');
                            }

                            actionGuidance = `
                                シミュレーションデバイスをオンラインにするには:
                                1. [修復済み] シミュレーションモードを再初期化しました
                                2. デバイスを一度削除して再度追加してみてください
                                3. 「デバイスを追加」ボタンをクリックして新しいデバイスを作成してください
                                4. APIサーバーを再起動してみてください

                                修復処理を実行しました。問題が解決していなければ、
                                「再試行」ボタンをクリックしてください。
                            `;
                        } else {
                            actionGuidance = `
                                実デバイスをオンラインにするには:
                                1. デバイスの電源と接続を確認する
                                2. デバイスが同じネットワークに接続されているか確認する
                                3. デバイス検出を実行して再接続を試みる
                            `;
                        }
                    } else if (data.message && data.message.includes('not found')) {
                        addLog(`デバイス ${deviceId} は見つかりません`, 'error');
                        errorReason = 'デバイスがシステムに登録されていません';

                        // シミュレーションデバイスの場合は自動的に追加を試みる
                        if (deviceId.startsWith('sim_')) {
                            addLog('シミュレーションデバイスの自動追加を試みます', 'info');
                            try {
                                // 新しいシミュレーションデバイスを追加
                                await addSimulationDevice();
                                actionGuidance = `
                                    シミュレーションデバイスを自動的に追加しました。
                                    「再試行」ボタンをクリックして、新しいデバイス情報を取得してください。
                                `;

                                // 再度デバイス情報を取得するための関数を設定
                                retryAction = async () => {
                                    addLog(`デバイス一覧を更新して最新のデバイス情報を取得します`, 'info');
                                    // 最新のデバイスIDを取得
                                    const latestDevices = await fetch('/api/simulation/devices');
                                    const devData = await latestDevices.json();
                                    if (devData.status === 'success' && devData.data.devices.length > 0) {
                                        // 最新のデバイスを取得
                                        const latestDevice = devData.data.devices[devData.data.devices.length - 1];
                                        await viewDeviceInfo(latestDevice.id);
                                    }
                                };
                            } catch (autoAddErr) {
                                addLog(`シミュレーションデバイス自動追加エラー: ${autoAddErr.message}`, 'error');
                                actionGuidance = `
                                    デバイスを登録するには:
                                    1. シミュレーションデバイスの場合: 「デバイスを追加」ボタンをクリック
                                    2. 実デバイスの場合: デバイス検出を実行してください
                                `;
                            }
                        } else {
                            actionGuidance = `
                                デバイスを登録するには:
                                1. シミュレーションデバイスの場合: 「デバイスを追加」ボタンをクリック
                                2. 実デバイスの場合: デバイス検出を実行してください
                            `;
                        }
                    } else {
                        addLog(`エラー: ${data.message || '情報の取得に失敗しました'}`, 'error');
                        errorReason = data.message || '不明なエラーが発生しました';
                        actionGuidance = `
                            問題を解決するには:
                            1. APIサーバーのログを確認する
                            2. ブラウザのコンソールログを確認する
                            3. APIサーバーを再起動してみる
                        `;
                    }

                    // 詳細なデバイス状態情報を表示（再試行ボタン付き）
                    const deviceStateInfo = `
                        デバイス情報: ${deviceId}
                        ----------------------------------------
                        ステータス: エラー
                        エラー内容: ${errorReason}

                        ≪ 対処方法 ≫
                        ${actionGuidance}

                        ※ このエラーが継続する場合はAPIサーバーを再起動してください
                    `;

                    // 再試行アクションがある場合は確認ダイアログを表示
                    if (retryAction) {
                        if (confirm(deviceStateInfo.replace(/\n/g, '\n') + "\n\n再試行しますか？")) {
                            await retryAction();
                            return; // 再試行アクションが実行された場合は終了
                        }
                    } else {
                        alert(deviceStateInfo.replace(/\n/g, '\n'));
                    }
                }
            } catch (error) {
                console.error(`デバイス ${deviceId} 情報取得エラー:`, error);
                addLog(`デバイス情報取得エラー: ${error.message}`, 'error');

                // ネットワークエラーなど特定のエラーパターンに対する詳細なガイダンス
                let troubleshootingSteps = '';

                if (error.message.includes('タイムアウト') || error.message.includes('failed to fetch')) {
                    troubleshootingSteps = `
                        ネットワークエラーの解決方法:
                        1. APIサーバー(ポート5001)が起動していることを確認
                        2. ブラウザがAPIサーバーにアクセスできることを確認
                        3. ファイアウォールやネットワーク設定を確認
                    `;
                } else {
                    troubleshootingSteps = `
                        一般的な解決方法:
                        1. APIサーバーが起動しているか確認
                        2. シミュレーションモードを一度無効にして再度有効にしてみる
                        3. ブラウザをリロードする
                        4. デバイスを再追加してみる
                    `;
                }

                const errorInfo = `
                    デバイス ${deviceId} の情報を取得できませんでした
                    ----------------------------------------
                    エラー: ${error.message}

                    ≪ トラブルシューティング ≫
                    ${troubleshootingSteps}

                    ※ デバイスIDとエラーメッセージをメモして、サポートに連絡してください
                `;

                alert(errorInfo.replace(/\n/g, '\n'));
            }
        }

        // イベントリスナー設定
        function setupEventListeners() {
            elements.toggleSimulation.addEventListener('click', toggleSimulationMode);
            elements.updateDeviceCount.addEventListener('click', updateSimulationDeviceCount);
            elements.addDevice.addEventListener('click', addSimulationDevice);
            elements.removeLastDevice.addEventListener('click', removeLastDevice);
            elements.clearAllDevices.addEventListener('click', clearAllDevices);
        }

        // ページ読み込み後の初期化を保証する関数
        function ensureElementsInitialized() {
            return new Promise((resolve) => {
                // DOMが既に読み込み完了している場合は即時解決
                if (document.readyState === 'complete') {
                    console.log('DOM is already ready');
                    // 少し遅延させて要素が確実にアクセス可能になるようにする
                    setTimeout(() => resolve(true), 100);
                    return;
                }

                // DOMがまだ読み込み中の場合はイベントリスナーを設定
                const onReady = () => {
                    console.log('DOM is now ready');
                    document.removeEventListener('DOMContentLoaded', onReady);
                    // 少し遅延させて要素が確実にアクセス可能になるようにする
                    setTimeout(() => resolve(true), 100);
                };

                document.addEventListener('DOMContentLoaded', onReady);
            });
        }

        // 初期化
        async function initializeApp() {
            try {
                addLog('シミュレーション制御ユーティリティを初期化中...', 'info');

                // DOM要素の初期化を確実に行う
                await ensureElementsInitialized();

                // APIサーバーの情報を表示
                elements.wsAddress.textContent = `ws://${window.location.hostname}:5001`;

                // イベントリスナーとWebSocketの設定
                setupEventListeners();
                initWebSocket();

                addLog('初期化完了', 'success');

                // エラー通知が表示されなかった場合のみ、APIサーバー接続を試行
                setTimeout(async () => {
                    if (state.connected) {
                        console.log('APIサーバーに接続済み、接続確認をスキップ');
                        return;
                    }

                    console.log('APIサーバー接続確認を開始');
                    const isConnected = await checkApiServer().catch(() => false);
                    if (!isConnected) {
                        addLog('⚠️ APIサーバーへの接続に問題があります', 'error');
                        addLog('以下のコマンドでAPIサーバーを起動できます:', 'info');
                        addLog('cd .. && python app.py', 'info');
                    }
                }, 1000);
            } catch (error) {
                console.error('アプリケーション初期化エラー:', error);
                addLog(`初期化エラー: ${error.message}`, 'error');
            }
        }

        // アプリケーション初期化の開始
        initializeApp();
    </script>
</body>
</html>